name: Validate Device Profiles

on:
  pull_request:
    paths:
      - 'registry/**/*.yaml'
      - 'contrib/**/*.yaml'
      - 'schema/**/*.json'
      - 'tools/**'
  push:
    branches:
      - main
    paths:
      - 'registry/**/*.yaml'
      - 'contrib/**/*.yaml'
      - 'schema/**/*.json'

jobs:
  validate:
    name: Validate YAML against schema
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install jsonschema pyyaml

      - name: Validate all device profiles
        run: |
          python3 tools/validate.py

      - name: Check for changed files
        if: github.event_name == 'pull_request'
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            registry/**/*.yaml
            contrib/**/*.yaml

      - name: List changed device profiles
        if: github.event_name == 'pull_request' && steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "### Changed Device Profiles" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
          done

      - name: Validation successful
        run: |
          echo "### âœ… All device profiles are valid" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All YAML files conform to OpenModbus schema v0.1" >> $GITHUB_STEP_SUMMARY

  lint-yaml:
    name: Lint YAML files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint -c .yamllint registry/ contrib/ || true
        continue-on-error: true
